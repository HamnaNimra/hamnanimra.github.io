# Sync public GitHub repositories to _data/github_projects.yml
# Runs on schedule, on push to main, and on workflow_dispatch; pushes updates to the repo.
name: Sync GitHub Repos

on:
  schedule:
    # Run daily at 00:00 UTC to keep repositories synced
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - '.gitignore'
      - 'LICENSE'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch public repos
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USER: ${{ github.repository_owner }}
        run: |
          echo "Fetching repositories for user: ${GITHUB_USER}"
          
          # Fetch all public repos (paginated)
          curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/users/${GITHUB_USER}/repos?per_page=100&sort=updated&type=owner&direction=desc" \
            | jq '[ .[] | select(.private == false) | {name, description, html_url, stargazers_count, forks_count, updated_at, language} ]' \
            > repos.json
          
          repos_count=$(jq length repos.json)
          echo "Found ${repos_count} public repositories"
          echo "repos_count=${repos_count}" >> $GITHUB_OUTPUT
          
          # Show first few repo names for debugging
          echo "Sample repos:"
          jq -r '.[0:3] | .[] | .name' repos.json || echo "No repos found"

      - name: Build YAML
        run: |
          ruby scripts/build_github_projects_yml.rb
          echo "YAML file generated successfully"

      - name: Commit and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are any changes (we're on main with freshly built YAML)
          if git diff --quiet _data/github_projects.yml; then
            echo "No changes to commit - repositories are up to date"
            exit 0
          fi
          
          # Use a consistent branch name to update the same PR
          BRANCH_NAME="sync-github-repos"
          
          # Create or reset branch to current HEAD but KEEP working tree (preserves new YAML)
          git checkout -B ${BRANCH_NAME}
          
          # Remove build artifact so it's not committed or reported as untracked
          rm -f repos.json
          
          # Commit and push
          git add _data/github_projects.yml
          git commit -m "chore: sync github_projects.yml from API [skip ci]"
          
          # Push to the branch (force push to update)
          git push -f https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:${BRANCH_NAME}
          
          # Check if PR already exists (head must be owner:branch per GitHub API)
          EXISTING_PR=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=open&head=${GITHUB_REPOSITORY_OWNER}:${BRANCH_NAME}" \
            | jq -r '.[0].number // empty')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "Updated existing PR #${EXISTING_PR}"
            echo "PR URL: https://github.com/${GITHUB_REPOSITORY}/pull/${EXISTING_PR}"
            echo "PR can be merged manually. Since this is a data-only update, you can bypass the deployment requirement."
          else
            # Create new PR (head is owner:branch for API)
            PR_HEAD="${GITHUB_REPOSITORY_OWNER}:${BRANCH_NAME}"
            PR_RESPONSE=$(curl -s -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls \
              -d "{\"title\":\"chore: sync github_projects.yml from API\",\"head\":\"${PR_HEAD}\",\"base\":\"main\",\"body\":\"ðŸ¤– Auto-sync of GitHub repositories data.\\n\\nThis PR updates the \`_data/github_projects.yml\` file with the latest public repositories from GitHub.\\n\\n**Note:** This is a data-only update. You can merge this PR manually and bypass the deployment requirement if needed, as it only updates repository metadata.\"}")
            
            PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number // empty')
            ERROR_MSG=$(echo "$PR_RESPONSE" | jq -r '.message // empty')
            
            if [ -n "$PR_NUMBER" ]; then
              echo "Created PR #${PR_NUMBER}"
              echo "PR URL: https://github.com/${GITHUB_REPOSITORY}/pull/${PR_NUMBER}"
              echo "PR can be merged manually. Since this is a data-only update, you can bypass the deployment requirement."
            elif [ -n "$ERROR_MSG" ] && [[ "$ERROR_MSG" == *"already exists"* ]]; then
              echo "PR already exists for this branch; branch was updated. Open or merge the existing PR."
            else
              echo "Failed to create PR: $ERROR_MSG"
              echo "Response: $PR_RESPONSE"
              exit 1
            fi
          fi
          
          echo "Successfully updated github_projects.yml"
