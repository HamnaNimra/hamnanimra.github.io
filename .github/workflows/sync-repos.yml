# Sync public GitHub repositories to _data/github_projects.yml
# Runs on schedule and on workflow_dispatch; pushes updates to the repo.
name: Sync GitHub Repos

on:
  push:
    branches:
      - main
  schedule:
    # Run weekly (Monday 00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch public repos
        id: fetch
        env:
          GITHUB_USER: ${{ github.repository_owner }}
        run: |
          curl -s \
            "https://api.github.com/users/${GITHUB_USER}/repos?per_page=100&sort=updated&type=owner" \
            | jq -c '[ .[] | {name, description, html_url, stargazers_count, forks_count, updated_at, language} ]' \
            > repos.json
          echo "repos_count=$(jq length repos.json)" >> $GITHUB_OUTPUT

      - name: Build YAML
        run: |
          ruby -rjson -ryaml -e "
            repos = JSON.load(File.read('repos.json'))
            out = {
              'repositories' => repos.map { |r|
                {
                  'name' => r['name'],
                  'description' => r['description'].to_s,
                  'html_url' => r['html_url'],
                  'stargazers_count' => r['stargazers_count'],
                  'forks_count' => r['forks_count'],
                  'updated_at' => r['updated_at'],
                  'language' => r['language'].to_s
                }
              }
            }
            File.write('_data/github_projects.yml', '# Auto-generated by .github/workflows/sync-repos.yml\n' + out.to_yaml)
          "

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet _data/github_projects.yml && echo "No changes" && exit 0
          git add _data/github_projects.yml
          git commit -m "chore: sync github_projects.yml from API"
          git push
